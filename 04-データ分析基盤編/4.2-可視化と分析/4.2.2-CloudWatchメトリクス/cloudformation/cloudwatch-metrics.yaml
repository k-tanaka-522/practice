AWSTemplateFormatVersion: '2010-09-09'
Description: |
  CloudWatch ã‚«ã‚¹ã‚¿ãƒ ãƒ¡ãƒˆãƒªã‚¯ã‚¹ãƒ»ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ - é‹ç”¨ç›£è¦–åŸºç›¤
  
  ã“ã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã¯ä»¥ä¸‹ã®ãƒªã‚½ãƒ¼ã‚¹ã‚’ä½œæˆã—ã¾ã™ï¼š
  - CloudWatch ã‚«ã‚¹ã‚¿ãƒ ãƒ¡ãƒˆãƒªã‚¯ã‚¹ï¼ˆãƒ“ã‚¸ãƒã‚¹KPIï¼‰
  - CloudWatch ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ï¼ˆé‹ç”¨ãƒ»ãƒ“ã‚¸ãƒã‚¹ç›£è¦–ï¼‰
  - CloudWatch ã‚¢ãƒ©ãƒ¼ãƒ ï¼ˆé–¾å€¤ç›£è¦–ãƒ»ç•°å¸¸æ¤œçŸ¥ï¼‰
  - Lambdaé–¢æ•°ï¼ˆãƒ¡ãƒˆãƒªã‚¯ã‚¹åé›†ãƒ»åˆ†æï¼‰
  - SNSé€šçŸ¥ï¼ˆã‚¢ãƒ©ãƒ¼ãƒˆé…ä¿¡ï¼‰
  - CloudWatch Insightsï¼ˆãƒ­ã‚°åˆ†æï¼‰

Parameters:
  EnvironmentName:
    Type: String
    Default: dev
    AllowedValues: [dev, staging, prod]
    Description: |
      ç’°å¢ƒå
      - dev: é–‹ç™ºç’°å¢ƒï¼ˆåŸºæœ¬ç›£è¦–ï¼‰
      - staging: ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ç’°å¢ƒï¼ˆè©³ç´°ç›£è¦–ï¼‰
      - prod: æœ¬ç•ªç’°å¢ƒï¼ˆé«˜åº¦ç›£è¦–ãƒ»ã‚¢ãƒ©ãƒ¼ãƒˆï¼‰

  ProjectName:
    Type: String
    Default: cloudwatch-metrics
    Description: ãƒªã‚½ãƒ¼ã‚¹å‘½åã«ä½¿ç”¨ã™ã‚‹ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå

  # ç›£è¦–å¯¾è±¡è¨­å®š
  ApplicationName:
    Type: String
    Default: web-application
    Description: ç›£è¦–å¯¾è±¡ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å

  # ãƒ¡ãƒˆãƒªã‚¯ã‚¹åé›†è¨­å®š
  MetricsCollectionInterval:
    Type: Number
    Default: 300
    AllowedValues: [60, 300, 900, 3600]
    Description: |
      ãƒ¡ãƒˆãƒªã‚¯ã‚¹åé›†é–“éš”ï¼ˆç§’ï¼‰
      - 60: 1åˆ†é–“éš”ï¼ˆé«˜é »åº¦ç›£è¦–ï¼‰
      - 300: 5åˆ†é–“éš”ï¼ˆæ¨™æº–ï¼‰
      - 900: 15åˆ†é–“éš”ï¼ˆä½é »åº¦ï¼‰
      - 3600: 1æ™‚é–“é–“éš”ï¼ˆé•·æœŸç›£è¦–ï¼‰

  # ã‚¢ãƒ©ãƒ¼ãƒˆè¨­å®š
  AlertEmail:
    Type: String
    Default: admin@example.com
    Description: ã‚¢ãƒ©ãƒ¼ãƒˆé€šçŸ¥ç”¨ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹

  SlackWebhookUrl:
    Type: String
    Default: ""
    Description: |
      Slack Webhook URLï¼ˆä»»æ„ï¼‰
      Slacké€šçŸ¥ã‚’ä½¿ç”¨ã™ã‚‹å ´åˆã«è¨­å®š

  # ç›£è¦–ãƒ¬ãƒ™ãƒ«è¨­å®š
  MonitoringLevel:
    Type: String
    Default: standard
    AllowedValues: [basic, standard, advanced, enterprise]
    Description: |
      ç›£è¦–ãƒ¬ãƒ™ãƒ«
      - basic: åŸºæœ¬çš„ãªãƒ¡ãƒˆãƒªã‚¯ã‚¹
      - standard: è©³ç´°ãªãƒ¡ãƒˆãƒªã‚¯ã‚¹
      - advanced: ã‚«ã‚¹ã‚¿ãƒ ãƒ¡ãƒˆãƒªã‚¯ã‚¹
      - enterprise: AI/MLç•°å¸¸æ¤œçŸ¥

Conditions:
  # æœ¬ç•ªç’°å¢ƒã‹ã©ã†ã‹
  IsProduction: !Equals [!Ref EnvironmentName, 'prod']
  
  # ç›£è¦–ãƒ¬ãƒ™ãƒ«åˆ¤å®š
  IsStandardMonitoring: !Or
    - !Equals [!Ref MonitoringLevel, 'standard']
    - !Equals [!Ref MonitoringLevel, 'advanced']
    - !Equals [!Ref MonitoringLevel, 'enterprise']
  
  IsAdvancedMonitoring: !Or
    - !Equals [!Ref MonitoringLevel, 'advanced']
    - !Equals [!Ref MonitoringLevel, 'enterprise']
  
  IsEnterpriseMonitoring: !Equals [!Ref MonitoringLevel, 'enterprise']
  
  # Slacké€šçŸ¥ã‚’ä½¿ç”¨ã™ã‚‹ã‹
  UseSlackNotification: !Not [!Equals [!Ref SlackWebhookUrl, ""]]

Resources:
  # ========================================
  # CloudWatch ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰
  # ========================================
  # ã‚·ã‚¹ãƒ†ãƒ é‹ç”¨ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰
  SystemOperationsDashboard:
    Type: AWS::CloudWatch::Dashboard
    Properties:
      DashboardName: !Sub '${ProjectName}-${EnvironmentName}-system-operations'
      DashboardBody: !Sub |
        {
          "widgets": [
            {
              "type": "metric",
              "x": 0,
              "y": 0,
              "width": 12,
              "height": 6,
              "properties": {
                "metrics": [
                  [ "${ProjectName}/Application", "RequestCount", "Application", "${ApplicationName}", "Environment", "${EnvironmentName}" ],
                  [ ".", "ErrorRate", ".", ".", ".", "." ],
                  [ ".", "ResponseTime", ".", ".", ".", "." ]
                ],
                "view": "timeSeries",
                "stacked": false,
                "region": "${AWS::Region}",
                "title": "ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³åŸºæœ¬ãƒ¡ãƒˆãƒªã‚¯ã‚¹",
                "period": ${MetricsCollectionInterval},
                "yAxis": {
                  "left": {
                    "min": 0
                  }
                }
              }
            },
            {
              "type": "metric",
              "x": 12,
              "y": 0,
              "width": 12,
              "height": 6,
              "properties": {
                "metrics": [
                  [ "AWS/EC2", "CPUUtilization" ],
                  [ "AWS/ApplicationELB", "TargetResponseTime" ],
                  [ "AWS/Lambda", "Duration" ]
                ],
                "view": "timeSeries",
                "stacked": false,
                "region": "${AWS::Region}",
                "title": "ã‚¤ãƒ³ãƒ•ãƒ©ã‚¹ãƒˆãƒ©ã‚¯ãƒãƒ£ãƒ¡ãƒˆãƒªã‚¯ã‚¹",
                "period": ${MetricsCollectionInterval}
              }
            },
            {
              "type": "metric",
              "x": 0,
              "y": 6,
              "width": 8,
              "height": 6,
              "properties": {
                "metrics": [
                  [ "${ProjectName}/Business", "ActiveUsers", "Application", "${ApplicationName}" ],
                  [ ".", "NewSignups", ".", "." ],
                  [ ".", "Revenue", ".", "." ]
                ],
                "view": "timeSeries",
                "stacked": false,
                "region": "${AWS::Region}",
                "title": "ãƒ“ã‚¸ãƒã‚¹KPIãƒ¡ãƒˆãƒªã‚¯ã‚¹",
                "period": ${MetricsCollectionInterval}
              }
            },
            {
              "type": "metric",
              "x": 8,
              "y": 6,
              "width": 8,
              "height": 6,
              "properties": {
                "metrics": [
                  [ "${ProjectName}/Security", "FailedLogins", "Application", "${ApplicationName}" ],
                  [ ".", "SuspiciousActivity", ".", "." ],
                  [ ".", "ApiRateLimit", ".", "." ]
                ],
                "view": "timeSeries",
                "stacked": false,
                "region": "${AWS::Region}",
                "title": "ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ¡ãƒˆãƒªã‚¯ã‚¹",
                "period": ${MetricsCollectionInterval}
              }
            },
            {
              "type": "metric",
              "x": 16,
              "y": 6,
              "width": 8,
              "height": 6,
              "properties": {
                "metrics": [
                  [ "${ProjectName}/Performance", "DatabaseConnections", "Application", "${ApplicationName}" ],
                  [ ".", "CacheHitRatio", ".", "." ],
                  [ ".", "QueueLength", ".", "." ]
                ],
                "view": "timeSeries",
                "stacked": false,
                "region": "${AWS::Region}",
                "title": "ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ¡ãƒˆãƒªã‚¯ã‚¹",
                "period": ${MetricsCollectionInterval}
              }
            },
            {
              "type": "log",
              "x": 0,
              "y": 12,
              "width": 24,
              "height": 6,
              "properties": {
                "query": "SOURCE '/aws/lambda/${ProjectName}-${EnvironmentName}' | fields @timestamp, @message\\n| filter @message like /ERROR/\\n| sort @timestamp desc\\n| limit 100",
                "region": "${AWS::Region}",
                "title": "æœ€æ–°ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°",
                "view": "table"
              }
            }
          ]
        }

  # ãƒ“ã‚¸ãƒã‚¹KPIãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰
  BusinessKPIDashboard:
    Type: AWS::CloudWatch::Dashboard
    Condition: IsStandardMonitoring
    Properties:
      DashboardName: !Sub '${ProjectName}-${EnvironmentName}-business-kpi'
      DashboardBody: !Sub |
        {
          "widgets": [
            {
              "type": "metric",
              "x": 0,
              "y": 0,
              "width": 6,
              "height": 6,
              "properties": {
                "metrics": [
                  [ "${ProjectName}/Business", "ActiveUsers", "Application", "${ApplicationName}" ]
                ],
                "view": "singleValue",
                "region": "${AWS::Region}",
                "title": "ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°",
                "period": ${MetricsCollectionInterval},
                "stat": "Average"
              }
            },
            {
              "type": "metric",
              "x": 6,
              "y": 0,
              "width": 6,
              "height": 6,
              "properties": {
                "metrics": [
                  [ "${ProjectName}/Business", "Revenue", "Application", "${ApplicationName}" ]
                ],
                "view": "singleValue",
                "region": "${AWS::Region}",
                "title": "å£²ä¸Šï¼ˆæ—¥æ¬¡ï¼‰",
                "period": ${MetricsCollectionInterval},
                "stat": "Sum"
              }
            },
            {
              "type": "metric",
              "x": 12,
              "y": 0,
              "width": 6,
              "height": 6,
              "properties": {
                "metrics": [
                  [ "${ProjectName}/Business", "ConversionRate", "Application", "${ApplicationName}" ]
                ],
                "view": "singleValue",
                "region": "${AWS::Region}",
                "title": "ã‚³ãƒ³ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç‡ï¼ˆ%ï¼‰",
                "period": ${MetricsCollectionInterval},
                "stat": "Average"
              }
            },
            {
              "type": "metric",
              "x": 18,
              "y": 0,
              "width": 6,
              "height": 6,
              "properties": {
                "metrics": [
                  [ "${ProjectName}/Business", "CustomerSatisfaction", "Application", "${ApplicationName}" ]
                ],
                "view": "singleValue",
                "region": "${AWS::Region}",
                "title": "é¡§å®¢æº€è¶³åº¦",
                "period": ${MetricsCollectionInterval},
                "stat": "Average"
              }
            },
            {
              "type": "metric",
              "x": 0,
              "y": 6,
              "width": 12,
              "height": 6,
              "properties": {
                "metrics": [
                  [ "${ProjectName}/Business", "ActiveUsers", "Application", "${ApplicationName}" ],
                  [ ".", "NewSignups", ".", "." ],
                  [ ".", "ChurnRate", ".", "." ]
                ],
                "view": "timeSeries",
                "stacked": false,
                "region": "${AWS::Region}",
                "title": "ãƒ¦ãƒ¼ã‚¶ãƒ¼é–¢é€£KPIæ¨ç§»",
                "period": 3600
              }
            },
            {
              "type": "metric",
              "x": 12,
              "y": 6,
              "width": 12,
              "height": 6,
              "properties": {
                "metrics": [
                  [ "${ProjectName}/Business", "Revenue", "Application", "${ApplicationName}" ],
                  [ ".", "AverageOrderValue", ".", "." ],
                  [ ".", "TransactionCount", ".", "." ]
                ],
                "view": "timeSeries",
                "stacked": false,
                "region": "${AWS::Region}",
                "title": "å£²ä¸Šé–¢é€£KPIæ¨ç§»",
                "period": 3600
              }
            }
          ]
        }

  # ========================================
  # Lambdaé–¢æ•°ï¼ˆãƒ¡ãƒˆãƒªã‚¯ã‚¹åé›†ï¼‰
  # ========================================
  # ãƒ“ã‚¸ãƒã‚¹ãƒ¡ãƒˆãƒªã‚¯ã‚¹åé›†Lambda
  BusinessMetricsCollector:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${EnvironmentName}-business-metrics'
      Runtime: python3.9
      Handler: index.lambda_handler
      Role: !GetAtt MetricsCollectorRole.Arn
      Timeout: 300
      MemorySize: 512
      Environment:
        Variables:
          APPLICATION_NAME: !Ref ApplicationName
          ENVIRONMENT: !Ref EnvironmentName
          PROJECT_NAME: !Ref ProjectName
      Code:
        ZipFile: |
          import json
          import boto3
          import os
          import random
          from datetime import datetime, timedelta
          
          cloudwatch = boto3.client('cloudwatch')
          
          def lambda_handler(event, context):
              """ãƒ“ã‚¸ãƒã‚¹ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã®åé›†ã¨é€ä¿¡"""
              
              try:
                  application_name = os.environ['APPLICATION_NAME']
                  environment = os.environ['ENVIRONMENT']
                  project_name = os.environ['PROJECT_NAME']
                  
                  # ãƒ€ãƒŸãƒ¼ãƒ‡ãƒ¼ã‚¿ç”Ÿæˆï¼ˆå®Ÿéš›ã®ç’°å¢ƒã§ã¯ã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚„APIã‹ã‚‰å–å¾—ï¼‰
                  metrics_data = {
                      'ActiveUsers': generate_active_users(),
                      'NewSignups': generate_new_signups(),
                      'Revenue': generate_revenue(),
                      'ConversionRate': generate_conversion_rate(),
                      'CustomerSatisfaction': generate_customer_satisfaction(),
                      'ChurnRate': generate_churn_rate(),
                      'AverageOrderValue': generate_average_order_value(),
                      'TransactionCount': generate_transaction_count()
                  }
                  
                  # CloudWatchãƒ¡ãƒˆãƒªã‚¯ã‚¹ã«é€ä¿¡
                  metric_data = []
                  timestamp = datetime.utcnow()
                  
                  for metric_name, value in metrics_data.items():
                      metric_data.append({
                          'MetricName': metric_name,
                          'Value': value,
                          'Unit': 'Count' if metric_name in ['ActiveUsers', 'NewSignups', 'TransactionCount'] else 'Percent' if 'Rate' in metric_name or 'Satisfaction' in metric_name else 'None',
                          'Timestamp': timestamp,
                          'Dimensions': [
                              {
                                  'Name': 'Application',
                                  'Value': application_name
                              },
                              {
                                  'Name': 'Environment',
                                  'Value': environment
                              }
                          ]
                      })
                  
                  # ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚’ãƒãƒƒãƒã§é€ä¿¡
                  for i in range(0, len(metric_data), 20):  # CloudWatchã®åˆ¶é™ï¼š20å€‹ãšã¤
                      batch = metric_data[i:i+20]
                      cloudwatch.put_metric_data(
                          Namespace=f'{project_name}/Business',
                          MetricData=batch
                      )
                  
                  print(f"Successfully sent {len(metric_data)} business metrics")
                  
                  return {
                      'statusCode': 200,
                      'body': json.dumps({
                          'message': 'Business metrics collected successfully',
                          'metrics_count': len(metric_data),
                          'timestamp': timestamp.isoformat()
                      })
                  }
                  
              except Exception as e:
                  print(f"Error collecting business metrics: {str(e)}")
                  return {
                      'statusCode': 500,
                      'body': json.dumps({
                          'error': str(e)
                      })
                  }
          
          def generate_active_users():
              """ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°ã‚’ç”Ÿæˆï¼ˆãƒ€ãƒŸãƒ¼ï¼‰"""
              base = 1000
              variation = random.randint(-100, 200)
              return max(0, base + variation)
          
          def generate_new_signups():
              """æ–°è¦ç™»éŒ²æ•°ã‚’ç”Ÿæˆï¼ˆãƒ€ãƒŸãƒ¼ï¼‰"""
              return random.randint(10, 50)
          
          def generate_revenue():
              """å£²ä¸Šã‚’ç”Ÿæˆï¼ˆãƒ€ãƒŸãƒ¼ï¼‰"""
              return round(random.uniform(5000, 15000), 2)
          
          def generate_conversion_rate():
              """ã‚³ãƒ³ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç‡ã‚’ç”Ÿæˆï¼ˆãƒ€ãƒŸãƒ¼ï¼‰"""
              return round(random.uniform(2.0, 8.0), 2)
          
          def generate_customer_satisfaction():
              """é¡§å®¢æº€è¶³åº¦ã‚’ç”Ÿæˆï¼ˆãƒ€ãƒŸãƒ¼ï¼‰"""
              return round(random.uniform(3.5, 4.8), 1)
          
          def generate_churn_rate():
              """ãƒãƒ£ãƒ¼ãƒ³ç‡ã‚’ç”Ÿæˆï¼ˆãƒ€ãƒŸãƒ¼ï¼‰"""
              return round(random.uniform(1.0, 5.0), 2)
          
          def generate_average_order_value():
              """å¹³å‡æ³¨æ–‡é¡ã‚’ç”Ÿæˆï¼ˆãƒ€ãƒŸãƒ¼ï¼‰"""
              return round(random.uniform(50, 200), 2)
          
          def generate_transaction_count():
              """å–å¼•æ•°ã‚’ç”Ÿæˆï¼ˆãƒ€ãƒŸãƒ¼ï¼‰"""
              return random.randint(100, 500)
      Tags:
        - Key: Environment
          Value: !Ref EnvironmentName
        - Key: Project
          Value: !Ref ProjectName

  # ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ¡ãƒˆãƒªã‚¯ã‚¹åé›†Lambda
  ApplicationMetricsCollector:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${EnvironmentName}-app-metrics'
      Runtime: python3.9
      Handler: index.lambda_handler
      Role: !GetAtt MetricsCollectorRole.Arn
      Timeout: 300
      MemorySize: 512
      Environment:
        Variables:
          APPLICATION_NAME: !Ref ApplicationName
          ENVIRONMENT: !Ref EnvironmentName
          PROJECT_NAME: !Ref ProjectName
      Code:
        ZipFile: |
          import json
          import boto3
          import os
          import random
          from datetime import datetime
          
          cloudwatch = boto3.client('cloudwatch')
          
          def lambda_handler(event, context):
              """ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã®åé›†ã¨é€ä¿¡"""
              
              try:
                  application_name = os.environ['APPLICATION_NAME']
                  environment = os.environ['ENVIRONMENT']
                  project_name = os.environ['PROJECT_NAME']
                  
                  # ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ¡ãƒˆãƒªã‚¯ã‚¹ç”Ÿæˆ
                  metrics_data = {
                      'RequestCount': generate_request_count(),
                      'ErrorRate': generate_error_rate(),
                      'ResponseTime': generate_response_time(),
                      'DatabaseConnections': generate_db_connections(),
                      'CacheHitRatio': generate_cache_hit_ratio(),
                      'QueueLength': generate_queue_length(),
                      'FailedLogins': generate_failed_logins(),
                      'SuspiciousActivity': generate_suspicious_activity(),
                      'ApiRateLimit': generate_api_rate_limit()
                  }
                  
                  # ãƒ¡ãƒˆãƒªã‚¯ã‚¹é€ä¿¡
                  timestamp = datetime.utcnow()
                  
                  # ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ¡ãƒˆãƒªã‚¯ã‚¹
                  app_metrics = ['RequestCount', 'ErrorRate', 'ResponseTime']
                  app_metric_data = []
                  
                  for metric_name in app_metrics:
                      app_metric_data.append({
                          'MetricName': metric_name,
                          'Value': metrics_data[metric_name],
                          'Unit': 'Count' if metric_name == 'RequestCount' else 'Percent' if metric_name == 'ErrorRate' else 'Milliseconds',
                          'Timestamp': timestamp,
                          'Dimensions': [
                              {
                                  'Name': 'Application',
                                  'Value': application_name
                              },
                              {
                                  'Name': 'Environment',
                                  'Value': environment
                              }
                          ]
                      })
                  
                  cloudwatch.put_metric_data(
                      Namespace=f'{project_name}/Application',
                      MetricData=app_metric_data
                  )
                  
                  # ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ¡ãƒˆãƒªã‚¯ã‚¹
                  perf_metrics = ['DatabaseConnections', 'CacheHitRatio', 'QueueLength']
                  perf_metric_data = []
                  
                  for metric_name in perf_metrics:
                      perf_metric_data.append({
                          'MetricName': metric_name,
                          'Value': metrics_data[metric_name],
                          'Unit': 'Count' if metric_name in ['DatabaseConnections', 'QueueLength'] else 'Percent',
                          'Timestamp': timestamp,
                          'Dimensions': [
                              {
                                  'Name': 'Application',
                                  'Value': application_name
                              }
                          ]
                      })
                  
                  cloudwatch.put_metric_data(
                      Namespace=f'{project_name}/Performance',
                      MetricData=perf_metric_data
                  )
                  
                  # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ¡ãƒˆãƒªã‚¯ã‚¹
                  sec_metrics = ['FailedLogins', 'SuspiciousActivity', 'ApiRateLimit']
                  sec_metric_data = []
                  
                  for metric_name in sec_metrics:
                      sec_metric_data.append({
                          'MetricName': metric_name,
                          'Value': metrics_data[metric_name],
                          'Unit': 'Count',
                          'Timestamp': timestamp,
                          'Dimensions': [
                              {
                                  'Name': 'Application',
                                  'Value': application_name
                              }
                          ]
                      })
                  
                  cloudwatch.put_metric_data(
                      Namespace=f'{project_name}/Security',
                      MetricData=sec_metric_data
                  )
                  
                  print(f"Successfully sent application metrics")
                  
                  return {
                      'statusCode': 200,
                      'body': json.dumps({
                          'message': 'Application metrics collected successfully',
                          'timestamp': timestamp.isoformat()
                      })
                  }
                  
              except Exception as e:
                  print(f"Error collecting application metrics: {str(e)}")
                  return {
                      'statusCode': 500,
                      'body': json.dumps({
                          'error': str(e)
                      })
                  }
          
          def generate_request_count():
              return random.randint(500, 2000)
          
          def generate_error_rate():
              return round(random.uniform(0.1, 2.0), 2)
          
          def generate_response_time():
              return random.randint(50, 500)
          
          def generate_db_connections():
              return random.randint(10, 50)
          
          def generate_cache_hit_ratio():
              return round(random.uniform(80, 95), 1)
          
          def generate_queue_length():
              return random.randint(0, 20)
          
          def generate_failed_logins():
              return random.randint(0, 10)
          
          def generate_suspicious_activity():
              return random.randint(0, 5)
          
          def generate_api_rate_limit():
              return random.randint(0, 100)
      Tags:
        - Key: Environment
          Value: !Ref EnvironmentName
        - Key: Project
          Value: !Ref ProjectName

  # ========================================
  # CloudWatch ã‚¢ãƒ©ãƒ¼ãƒ 
  # ========================================
  # é«˜ã‚¨ãƒ©ãƒ¼ç‡ã‚¢ãƒ©ãƒ¼ãƒ 
  HighErrorRateAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: !Sub '${ProjectName}-${EnvironmentName}-high-error-rate'
      AlarmDescription: ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼ç‡ãŒé«˜ã„
      MetricName: ErrorRate
      Namespace: !Sub '${ProjectName}/Application'
      Statistic: Average
      Period: !Ref MetricsCollectionInterval
      EvaluationPeriods: 2
      Threshold: !If [IsProduction, 1.0, 5.0]
      ComparisonOperator: GreaterThanThreshold
      TreatMissingData: notBreaching
      Dimensions:
        - Name: Application
          Value: !Ref ApplicationName
        - Name: Environment
          Value: !Ref EnvironmentName
      AlarmActions:
        - !Ref AlertTopic
      OKActions:
        - !Ref AlertTopic

  # é«˜ãƒ¬ã‚¹ãƒãƒ³ã‚¹æ™‚é–“ã‚¢ãƒ©ãƒ¼ãƒ 
  HighResponseTimeAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: !Sub '${ProjectName}-${EnvironmentName}-high-response-time'
      AlarmDescription: ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ¬ã‚¹ãƒãƒ³ã‚¹æ™‚é–“ãŒé•·ã„
      MetricName: ResponseTime
      Namespace: !Sub '${ProjectName}/Application'
      Statistic: Average
      Period: !Ref MetricsCollectionInterval
      EvaluationPeriods: 3
      Threshold: !If [IsProduction, 1000, 2000]
      ComparisonOperator: GreaterThanThreshold
      TreatMissingData: notBreaching
      Dimensions:
        - Name: Application
          Value: !Ref ApplicationName
        - Name: Environment
          Value: !Ref EnvironmentName
      AlarmActions:
        - !Ref AlertTopic

  # ãƒ“ã‚¸ãƒã‚¹KPIã‚¢ãƒ©ãƒ¼ãƒ ï¼ˆä½ã‚³ãƒ³ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç‡ï¼‰
  LowConversionRateAlarm:
    Type: AWS::CloudWatch::Alarm
    Condition: IsStandardMonitoring
    Properties:
      AlarmName: !Sub '${ProjectName}-${EnvironmentName}-low-conversion-rate'
      AlarmDescription: ã‚³ãƒ³ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç‡ãŒä½ä¸‹
      MetricName: ConversionRate
      Namespace: !Sub '${ProjectName}/Business'
      Statistic: Average
      Period: 3600
      EvaluationPeriods: 2
      Threshold: 2.0
      ComparisonOperator: LessThanThreshold
      TreatMissingData: notBreaching
      Dimensions:
        - Name: Application
          Value: !Ref ApplicationName
      AlarmActions:
        - !Ref AlertTopic

  # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¢ãƒ©ãƒ¼ãƒ ï¼ˆä¸å¯©ãªã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£ï¼‰
  SuspiciousActivityAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: !Sub '${ProjectName}-${EnvironmentName}-suspicious-activity'
      AlarmDescription: ä¸å¯©ãªã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£ã‚’æ¤œå‡º
      MetricName: SuspiciousActivity
      Namespace: !Sub '${ProjectName}/Security'
      Statistic: Sum
      Period: !Ref MetricsCollectionInterval
      EvaluationPeriods: 1
      Threshold: 3
      ComparisonOperator: GreaterThanThreshold
      TreatMissingData: notBreaching
      Dimensions:
        - Name: Application
          Value: !Ref ApplicationName
      AlarmActions:
        - !Ref AlertTopic

  # ========================================
  # ç•°å¸¸æ¤œçŸ¥ï¼ˆEnterpriseç›£è¦–ãƒ¬ãƒ™ãƒ«ï¼‰
  # ========================================
  # ç•°å¸¸æ¤œçŸ¥å™¨ï¼ˆãƒªã‚¯ã‚¨ã‚¹ãƒˆæ•°ï¼‰
  RequestCountAnomalyDetector:
    Type: AWS::CloudWatch::AnomalyDetector
    Condition: IsEnterpriseMonitoring
    Properties:
      MetricName: RequestCount
      Namespace: !Sub '${ProjectName}/Application'
      Stat: Average
      Dimensions:
        - Name: Application
          Value: !Ref ApplicationName
        - Name: Environment
          Value: !Ref EnvironmentName

  # ç•°å¸¸æ¤œçŸ¥ã‚¢ãƒ©ãƒ¼ãƒ 
  RequestCountAnomalyAlarm:
    Type: AWS::CloudWatch::Alarm
    Condition: IsEnterpriseMonitoring
    Properties:
      AlarmName: !Sub '${ProjectName}-${EnvironmentName}-request-count-anomaly'
      AlarmDescription: ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ•°ã®ç•°å¸¸ã‚’æ¤œçŸ¥
      ComparisonOperator: LessThanLowerOrGreaterThanUpperThreshold
      EvaluationPeriods: 2
      Metrics:
        - Id: m1
          ReturnData: true
          MetricStat:
            Metric:
              MetricName: RequestCount
              Namespace: !Sub '${ProjectName}/Application'
              Dimensions:
                - Name: Application
                  Value: !Ref ApplicationName
                - Name: Environment
                  Value: !Ref EnvironmentName
            Period: !Ref MetricsCollectionInterval
            Stat: Average
        - Id: ad1
          AnomalyDetector:
            MetricName: RequestCount
            Namespace: !Sub '${ProjectName}/Application'
            Stat: Average
            Dimensions:
              - Name: Application
                Value: !Ref ApplicationName
              - Name: Environment
                Value: !Ref EnvironmentName
      ThresholdMetricId: ad1
      AlarmActions:
        - !Ref AlertTopic

  # ========================================
  # ã‚¤ãƒ™ãƒ³ãƒˆã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒªãƒ³ã‚°
  # ========================================
  # ãƒ“ã‚¸ãƒã‚¹ãƒ¡ãƒˆãƒªã‚¯ã‚¹åé›†ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«
  BusinessMetricsSchedule:
    Type: AWS::Events::Rule
    Properties:
      Description: ãƒ“ã‚¸ãƒã‚¹ãƒ¡ãƒˆãƒªã‚¯ã‚¹å®šæœŸåé›†
      ScheduleExpression: !Sub 'rate(${MetricsCollectionInterval} seconds)'
      Targets:
        - Arn: !GetAtt BusinessMetricsCollector.Arn
          Id: BusinessMetricsTarget

  BusinessMetricsPermission:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName: !Ref BusinessMetricsCollector
      Principal: events.amazonaws.com
      SourceArn: !GetAtt BusinessMetricsSchedule.Arn

  # ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ¡ãƒˆãƒªã‚¯ã‚¹åé›†ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«
  ApplicationMetricsSchedule:
    Type: AWS::Events::Rule
    Properties:
      Description: ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ¡ãƒˆãƒªã‚¯ã‚¹å®šæœŸåé›†
      ScheduleExpression: !Sub 'rate(${MetricsCollectionInterval} seconds)'
      Targets:
        - Arn: !GetAtt ApplicationMetricsCollector.Arn
          Id: ApplicationMetricsTarget

  ApplicationMetricsPermission:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName: !Ref ApplicationMetricsCollector
      Principal: events.amazonaws.com
      SourceArn: !GetAtt ApplicationMetricsSchedule.Arn

  # ========================================
  # é€šçŸ¥è¨­å®š
  # ========================================
  # SNSã‚¢ãƒ©ãƒ¼ãƒˆãƒˆãƒ”ãƒƒã‚¯
  AlertTopic:
    Type: AWS::SNS::Topic
    Properties:
      TopicName: !Sub '${ProjectName}-${EnvironmentName}-alerts'
      DisplayName: !Sub '${ProjectName} ${EnvironmentName} ã‚¢ãƒ©ãƒ¼ãƒˆ'
      Tags:
        - Key: Environment
          Value: !Ref EnvironmentName
        - Key: Project
          Value: !Ref ProjectName

  # ãƒ¡ãƒ¼ãƒ«é€šçŸ¥ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³
  EmailSubscription:
    Type: AWS::SNS::Subscription
    Properties:
      Protocol: email
      TopicArn: !Ref AlertTopic
      Endpoint: !Ref AlertEmail

  # Slacké€šçŸ¥Lambdaï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
  SlackNotificationFunction:
    Type: AWS::Lambda::Function
    Condition: UseSlackNotification
    Properties:
      FunctionName: !Sub '${ProjectName}-${EnvironmentName}-slack-notification'
      Runtime: python3.9
      Handler: index.lambda_handler
      Role: !GetAtt SlackNotificationRole.Arn
      Timeout: 30
      MemorySize: 128
      Environment:
        Variables:
          SLACK_WEBHOOK_URL: !Ref SlackWebhookUrl
      Code:
        ZipFile: |
          import json
          import urllib3
          import os
          
          http = urllib3.PoolManager()
          
          def lambda_handler(event, context):
              """SNSãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’Slackã«è»¢é€"""
              
              try:
                  webhook_url = os.environ['SLACK_WEBHOOK_URL']
                  
                  for record in event['Records']:
                      sns_message = json.loads(record['Sns']['Message'])
                      
                      # Slackãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ä½œæˆ
                      slack_message = {
                          'text': f"ğŸš¨ *CloudWatch Alert*",
                          'attachments': [
                              {
                                  'color': 'danger' if 'ALARM' in record['Sns']['Subject'] else 'good',
                                  'fields': [
                                      {
                                          'title': 'Alert Name',
                                          'value': sns_message.get('AlarmName', 'Unknown'),
                                          'short': True
                                      },
                                      {
                                          'title': 'Status',
                                          'value': sns_message.get('NewStateValue', 'Unknown'),
                                          'short': True
                                      },
                                      {
                                          'title': 'Reason',
                                          'value': sns_message.get('NewStateReason', 'No details'),
                                          'short': False
                                      }
                                  ]
                              }
                          ]
                      }
                      
                      # Slackã«é€ä¿¡
                      response = http.request(
                          'POST',
                          webhook_url,
                          body=json.dumps(slack_message),
                          headers={'Content-Type': 'application/json'}
                      )
                      
                      print(f"Slack notification sent: {response.status}")
                  
                  return {
                      'statusCode': 200,
                      'body': json.dumps('Notifications sent successfully')
                  }
                  
              except Exception as e:
                  print(f"Error sending Slack notification: {str(e)}")
                  return {
                      'statusCode': 500,
                      'body': json.dumps(f'Error: {str(e)}')
                  }
      Tags:
        - Key: Environment
          Value: !Ref EnvironmentName
        - Key: Project
          Value: !Ref ProjectName

  # Slacké€šçŸ¥ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³
  SlackSubscription:
    Type: AWS::SNS::Subscription
    Condition: UseSlackNotification
    Properties:
      Protocol: lambda
      TopicArn: !Ref AlertTopic
      Endpoint: !GetAtt SlackNotificationFunction.Arn

  SlackNotificationPermission:
    Type: AWS::Lambda::Permission
    Condition: UseSlackNotification
    Properties:
      Action: lambda:InvokeFunction
      FunctionName: !Ref SlackNotificationFunction
      Principal: sns.amazonaws.com
      SourceArn: !Ref AlertTopic

  # ========================================
  # IAMãƒ­ãƒ¼ãƒ«
  # ========================================
  # ãƒ¡ãƒˆãƒªã‚¯ã‚¹åé›†Lambdaç”¨ãƒ­ãƒ¼ãƒ«
  MetricsCollectorRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
      Policies:
        - PolicyName: MetricsCollectorPolicy
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - cloudwatch:PutMetricData
                Resource: '*'

  # Slacké€šçŸ¥Lambdaç”¨ãƒ­ãƒ¼ãƒ«
  SlackNotificationRole:
    Type: AWS::IAM::Role
    Condition: UseSlackNotification
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole

# ========================================
# å‡ºåŠ›å€¤ï¼ˆä»–ã®ã‚¹ã‚¿ãƒƒã‚¯ã‹ã‚‰å‚ç…§å¯èƒ½ï¼‰
# ========================================
Outputs:
  # ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰URL
  SystemOperationsDashboardURL:
    Description: ã‚·ã‚¹ãƒ†ãƒ é‹ç”¨ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰URL
    Value: !Sub 'https://console.aws.amazon.com/cloudwatch/home?region=${AWS::Region}#dashboards:name=${ProjectName}-${EnvironmentName}-system-operations'
    Export:
      Name: !Sub '${AWS::StackName}-SystemDashboard-URL'

  BusinessKPIDashboardURL:
    Condition: IsStandardMonitoring
    Description: ãƒ“ã‚¸ãƒã‚¹KPIãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰URL
    Value: !Sub 'https://console.aws.amazon.com/cloudwatch/home?region=${AWS::Region}#dashboards:name=${ProjectName}-${EnvironmentName}-business-kpi'
    Export:
      Name: !Sub '${AWS::StackName}-BusinessDashboard-URL'

  # Lambdaé–¢æ•°ARN
  BusinessMetricsCollectorArn:
    Description: ãƒ“ã‚¸ãƒã‚¹ãƒ¡ãƒˆãƒªã‚¯ã‚¹åé›†Lambdaé–¢æ•°ARN
    Value: !GetAtt BusinessMetricsCollector.Arn
    Export:
      Name: !Sub '${AWS::StackName}-BusinessMetricsCollector'

  ApplicationMetricsCollectorArn:
    Description: ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ¡ãƒˆãƒªã‚¯ã‚¹åé›†Lambdaé–¢æ•°ARN
    Value: !GetAtt ApplicationMetricsCollector.Arn
    Export:
      Name: !Sub '${AWS::StackName}-ApplicationMetricsCollector'

  # é€šçŸ¥ãƒˆãƒ”ãƒƒã‚¯
  AlertTopicArn:
    Description: ã‚¢ãƒ©ãƒ¼ãƒˆé€šçŸ¥SNSãƒˆãƒ”ãƒƒã‚¯ARN
    Value: !Ref AlertTopic
    Export:
      Name: !Sub '${AWS::StackName}-AlertTopic'

  # ç›£è¦–è¨­å®šæƒ…å ±
  MonitoringConfiguration:
    Description: ç›£è¦–è¨­å®šæ¦‚è¦
    Value: !Sub |
      CloudWatchç›£è¦–åŸºç›¤:
      - ç›£è¦–ãƒ¬ãƒ™ãƒ«: ${MonitoringLevel}
      - ãƒ¡ãƒˆãƒªã‚¯ã‚¹åé›†é–“éš”: ${MetricsCollectionInterval}ç§’
      - ã‚·ã‚¹ãƒ†ãƒ ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰: https://console.aws.amazon.com/cloudwatch/home?region=${AWS::Region}#dashboards:name=${ProjectName}-${EnvironmentName}-system-operations
      - ã‚¢ãƒ©ãƒ¼ãƒˆé€šçŸ¥: ${AlertEmail}
      - ç•°å¸¸æ¤œçŸ¥: ${IsEnterpriseMonitoring}
      - ç®¡ç†ã‚³ãƒ³ã‚½ãƒ¼ãƒ«: https://console.aws.amazon.com/cloudwatch/home?region=${AWS::Region}